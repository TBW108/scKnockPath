# scKnckPath

A statistical model to find differential pathways that are conditionally correlated with target phenotypes by deconfounding the effect of overlapping genes with FDR control. This framework requires the scRNA-seq data preprocessed by scanpy, target FDR and .gmt pathway database file as input and outputs a ranked list of pathways.

## 1. Create the Enviroment
Run the following code to prepare the enviroment:
`conda env create -f sckp_env.yml`

If it fails, run the following code:
`CFLAGS="-std=c99" conda env create -f sckp_env.yml`

## 2. Preprocess the Dataset

For the quality-controlled gene count matrix, we sequentially applied
`scanpy.pp.log1p()` and `scanpy.pp.normalize_total()` to obtain
normalized expression values. We then identified the top $G$ (2000 in default) highly variable genes
using `scanpy.pp.highly_variable_genes()` and extracted their expression
profiles.

The various simulation scRNA-seq data is generated by scDesign3 https://github.com/SONGDONGYUAN1994/scDesign3 and the R scripts are in the folder `data/simulation`.

The two real scRNA-seq datasets come from https://www.gaultonlab.org/pages/Islet_expression_HPAP/ and https://data.humancellatlas.org/hca-bio-networks/lung/atlases/lung-v1-0. After preprocessing by `preprocess_hpap.ipynb` and `preprocess_hlca.ipynb`, the `processed_hpap.h5ad` and `lung_cov_norm.h5ad` are obtained for downstream pathway analysis.

The test scripts for simulation experiments and real experiments are included in the folder `test`.

## 2. Run the scKnockPath to Identify Pathways

For your own dataset, prepare the `.h5ad` scRNA-seq dataset and `.gmt` pathway database in the folder `./data`. In the commandline, run the following example code to obtain the results:

```bash
python ./test/real_exp/scKnockPath_run.py \
            --adata ./data/T1D/processed_hpap.h5ad \
            --obs_y diabetes_status \
            --geneset_path ./data/pathway_db/reactome_kegg.gmt \
            --gene_thresh 15 \
            --class1 ND
            --class2 AAB+
            --fdr 0.2 \
            --cell_type Beta
```

## 3. Output the Results

The model is saved as a `.pkl` file and you can upload it using 'pickle' package.

```python 3
cell_type="Beta"
with open(f'results/real_exp/processed_hpap/scKnockPath_results/scKnockPath_ND_AAB+_{cell_type}.pkl', 'rb') as f:
        model = pickle.load(f)
selected_pathways=pd.DataFrame(model.rank_pathways()[::-1])[:len(model.select_pathway(0.2))]
print(selected_pathways)
```
